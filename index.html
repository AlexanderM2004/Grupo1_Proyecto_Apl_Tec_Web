<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretosX</title>
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/colors.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/loader.css">
    <link rel="stylesheet" href="css/alerts.css">
    <script src="js/jQueryV3.7.1.js"></script>
    <script src="js/alertManager.js" defer></script>
    <script src="js/bootstrap/bootstrap.bundle.min.js" defer></script>
    <script src="js/custom.js" defer></script>
    <script src="js/animate.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/userProfile.js"></script>
    <script src="js/tagsInput.js"></script>
    <script src="js/loader.js" defer></script>
    <script src="js/whispers.js" defer></script>
    <script src="js/whisperPublisher.js" defer></script>
    <link rel="icon" type="image/svg+xml" href="image/favicon.svg">
</head>
<body>
    <!-- Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
            <h4 class="offcanvas-title mx-4 user-display-name" id="sidebarLabel">Hola, usuario</h4>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <p class="text-center user-display-handle">@usuario</p>
            <ul class="nav flex-column">
                <li><a href="Index.html" class="nav-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Inicio</div>
                    </a>
                </li>
                <li><a href="trend.html" class="nav-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Tendencias</div>                            
                    </a>
                </li>
                <li><a href="perfil.html" class="nav-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Mi Perfil</div>
                    </a>
                </li>
                <li><a href="login.html" class="nav-link logout-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Cerrar Sesión</div>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <div class="row minvh-100 p-4">
            <!-- Columna izquierda -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="p-3 bg-sidebar rounded h-100">
                    <h5 class="text-center user-display-name">Hola, usuario</h5>
                    <p class="text-center user-display-handle">@usuario</p>
                    <ul class="list-unstyled">
                        <li><a href="Index.html" class="nav-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Inicio</div>
                            </a>
                        </li>
                        <li><a href="trend.html" class="nav-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Tendencias</div>                            
                            </a>
                        </li>
                        <li><a href="perfil.html" class="nav-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Mi Perfil</div>
                            </a>
                        </li>
                        <li><a href="login.html" class="nav-link logout-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Cerrar Sesión</div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Columna 2 -->
            <div class="col-lg-6">
                <!-- Fila de búsqueda -->
                <div class="row mb-4 align-items-center ">
                    <div class="col-auto">
                        <button class="btn btn-toggle d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list text-white" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="col ps-0">
                        <input type="search" class="form-control rounded-pill bg-search text-white" placeholder="Buscar susurros..." autocomplete="off">
                    </div>
                </div>

                <!-- Contenido principal -->
                <div class="p-3 bg-content rounded d-flex flex-column gap-3">
                    <form class="whisper-form">
                        <textarea 
                            class="form-control text-white rounded whisper-box" 
                            rows="3" 
                            placeholder="¿Qué susurro quieres hacer conocer? 👀"
                            maxlength="500"
                        ></textarea>
                        <input 
                            type="text" 
                            class="form-control text-white rounded mb-3 tags-box" 
                            placeholder="Escribe tus etiquetas"
                        >
                        <button type="submit" class="btn btn-publish w-100">Publicar</button>
                        
                        <!-- Contador de caracteres -->
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-light char-counter">0/500</small>
                            <small class="text-light tags-counter">0 etiquetas</small>
                        </div>
                    </form>
                </div>
                <div class="row text-center text-white m-3">
                    <h3>Susurros recientes</h3>
                </div>
                <div id="recent-whispers" class="whispers-container">
                    <!-- Los susurros se cargarán aquí -->
                </div>
            </div>

            <!-- Columna derecha -->
            <div class="col-lg-3">
                <div class="p-3 bg-sidebar rounded mt-sm-4 mt-lg-0 h-100">
                    <h5 class="text-center mb-4">Etiquetas Populares ☝️🥸</h5>
                    <ul id="tags-loop" class="list-unstyled d-flex flex-wrap">
                       <!-- Las etiquetas populares se cargarán aquí -->
                    </ul>
                    <h5 class="text-center mb-4">Destacados 👀</h5>
                    <div id="popular-whispers-loop">
                        <!-- Los susurros destacados se cargarán aquí -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el renderer de susurros
            const whisperRenderer = new WhisperRenderer({
                container: document.querySelector('#recent-whispers'),
                infiniteScroll: true,
                showInterests: true,
                showLies: true,
                showResponses: true,
                showViews: false,
                showPercentage: true,
                initialLoad: 20,
                endpoint: '/api/whispers/recent'
            });

            // Inicializar el publicador de susurros
            const whisperPublisher = new WhisperPublisher({
                form: document.querySelector('.whisper-form'),
                messageInput: document.querySelector('.whisper-box'),
                tagsInput: document.querySelector('.tags-box'),
                publishButton: document.querySelector('.btn-publish'),
                renderer: whisperRenderer
            });

            // Inicializar el sistema de etiquetas
            const tagsBox = document.querySelector('.tags-box');
            if (tagsBox && !tagsBox.dataset.initialized) {
                new TagsInput(tagsBox);
            }

            // Inicializar contadores
            const whisperBox = document.querySelector('.whisper-box');
            const charCounter = document.querySelector('.char-counter');
            const tagsCounter = document.querySelector('.tags-counter');

            // Contador de caracteres
            if (whisperBox && charCounter) {
                whisperBox.addEventListener('input', function() {
                    const count = this.value.length;
                    charCounter.textContent = `${count}/500`;
                    charCounter.classList.toggle('text-warning', count >= 450);
                });
            }

            
            // Contador de etiquetas
            if (tagsCounter) {
                const updateTagsCounter = () => {
                    const tags = JSON.parse(document.querySelector('.tags-box').value || '[]');
                    tagsCounter.textContent = `${tags.length} etiqueta${tags.length !== 1 ? 's' : ''}`;
                };

                // Observador para el contador de etiquetas
                const tagsContainer = document.querySelector('.tags-container');
                if (tagsContainer) {
                    const observer = new MutationObserver(updateTagsCounter);
                    observer.observe(tagsContainer, { 
                        childList: true,
                        subtree: true 
                    });
                }
            }

            // Inicializar búsqueda
            const searchInput = document.querySelector('input[type="search"]');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchText = this.value.trim();
                        if (searchText.length >= 3) {
                            whisperRenderer.options.endpoint = `/api/whispers/search?q=${encodeURIComponent(searchText)}`;
                            whisperRenderer.reloadWhispers();
                        } else if (searchText.length === 0) {
                            whisperRenderer.options.endpoint = '/api/whispers/recent';
                            whisperRenderer.reloadWhispers();
                        }
                    }, 300);
                });
            }

            // Cargar datos iniciales
            whisperRenderer.loadPopularTags();
            whisperRenderer.loadFeaturedWhispers();
            whisperRenderer.loadMore();
        });
    </script>
</body>
</html>
