<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecretosX</title>
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/colors.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/loader.css">
    <link rel="stylesheet" href="css/alerts.css">
    <script src="js/jQueryV3.7.1.js"></script>
    <script src="js/alertManager.js" defer></script>
    <script src="js/bootstrap/bootstrap.bundle.min.js" defer></script>
    <script src="js/custom.js" defer></script>
    <script src="js/animate.js" defer></script>
    <script src="js/auth.js" defer></script>
    <script src="js/userProfile.js"></script>
    <script src="js/tagsInput.js"></script>
    <script src="js/loader.js" defer></script>
    <script src="js/whispers.js" defer></script>
    <script src="js/whisperPublisher.js" defer></script>
    <link rel="icon" type="image/svg+xml" href="image/favicon.svg">
</head>
<body>
    <!-- Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start bg-dark text-white" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
        <div class="offcanvas-header">
            <h4 class="offcanvas-title mx-4 user-display-name" id="sidebarLabel">Hola, usuario</h4>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <p class="text-center user-display-handle">@usuario</p>
            <ul class="nav flex-column">
                <li><a href="Index.html" class="nav-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Inicio</div>
                    </a>
                </li>
                <li><a href="trend.html" class="nav-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Tendencias</div>                            
                    </a>
                </li>
                <li><a href="perfil.html" class="nav-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Mi Perfil</div>
                    </a>
                </li>
                <li><a href="login.html" class="nav-link logout-link">
                    <div class="bg-tags p-2 m-2 rounded text-center">Cerrar Sesión</div>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <div class="row minvh-100 p-4">
            <!-- Columna izquierda -->
            <div class="col-lg-3 d-none d-lg-block">
                <div class="p-3 bg-sidebar rounded h-100">
                    <h5 class="text-center user-display-name">Hola, usuario</h5>
                    <p class="text-center user-display-handle">@usuario</p>
                    <ul class="list-unstyled">
                        <li><a href="Index.html" class="nav-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Inicio</div>
                            </a>
                        </li>
                        <li><a href="trend.html" class="nav-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Tendencias</div>                            
                            </a>
                        </li>
                        <li><a href="perfil.html" class="nav-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Mi Perfil</div>
                            </a>
                        </li>
                        <li><a href="login.html" class="nav-link logout-link">
                            <div style="background: var(--background-link-profile);" class="p-2 m-3 rounded text-center">Cerrar Sesión</div>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Columna 2 -->
            <div class="col-lg-6">
                <!-- Fila de búsqueda -->
                <div class="row mb-4 align-items-center ">
                    <div class="col-auto">
                        <button class="btn btn-toggle d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-list text-white" viewBox="0 0 16 16">
                                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="col ps-0">
                        <input type="search" class="form-control rounded-pill bg-search text-white" placeholder="Buscar susurros..." autocomplete="off">
                    </div>
                </div>

                <!-- Contenido principal -->
                <div class="p-3 bg-content rounded d-flex flex-column gap-3">
                    <form class="whisper-form">
                        <textarea 
                            class="form-control text-white rounded whisper-box" 
                            rows="3" 
                            placeholder="¿Qué susurro quieres hacer conocer? 👀"
                            maxlength="500"
                        ></textarea>
                        <input 
                            type="text" 
                            class="form-control text-white rounded mb-3 tags-box" 
                            placeholder="Escribe tus etiquetas"
                        >
                        <button type="submit" class="btn btn-publish w-100">Publicar</button>
                        
                        <!-- Contador de caracteres -->
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-light char-counter">0/500</small>
                            <small class="text-light tags-counter">0 etiquetas</small>
                        </div>
                    </form>
                </div>
                <div class="row text-center text-white m-3">
                    <h3>Susurros recientes</h3>
                </div>
                <div id="recent-whispers" class="whispers-container">
                    <!-- Los susurros se cargarán aquí -->
                </div>
                <div>
                    <a href="respuesta.html" class="link-a">
                        <div class="p-3 bg-content rounded mb-3 conte">
                            <div class="mx-2 row">
                                <div class="col-9">
                                    <div class="row gap-2">
                                        <div style="background: var(--comment-gener-male);" class="w-auto rounded-pill">
                                            <version="1.0" encoding="UTF-8"?><svg width="24px" height="24px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#000000">
                                                <path d="M14.2323 9.74707C13.1474 8.66733 11.6516 8 10 8C6.68629 8 4 10.6863 4 14C4 17.3137 6.68629 20 10 20C13.3137 20 16 17.3137 16 14C16 12.3379 15.3242 10.8337 14.2323 9.74707ZM14.2323 9.74707L20 4M20 4H16M20 4V8" stroke="#FFFFFF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                                El
                                        </div>
                                        <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill">🔥Hot</div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <p class="small text-end">Hace 2 horas</p>
                                </div>
                            </div>
                            <p class="m-2">Espero volver a ver a la viuda (Ericka) que me cautivo mucho ... :V</p>
                            <div class="row d-flex mx-2">
                                <div class="bg-tags p-1 rounded m-1 w-auto">#fiesta</div>
                                <div class="bg-tags p-1 rounded m-1 w-auto">#recuerdo</div>
                            </div>
                            <div class="row d-flex gap-2 mx-2">
                                <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                    <span class="icono position-absolute">🔥</span><span class="ms-4">1433</span>
                                </div>                            
                                <div style="background: var(--orange);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                    <span class="icono position-absolute">🤥</span><span class="ms-4">304</span>
                                </div>
                                <div class="w-auto mt-2">📧 56</div>
                            </div>
                        </div>
                    </a>
    
                    <div class="p-3 bg-content rounded mb-3 conte">
                        <div class="mx-2 row">
                            <div class="col-9">
                                <div class="row gap-2">
                                    <div style="background: var(--pink);" class="w-auto rounded-pill">
                                        <?xml version="1.0" encoding="UTF-8"?><svg width="24px" height="24px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#000000">
                                            <path d="M12 15C15.3137 15 18 12.3137 18 9C18 5.68629 15.3137 3 12 3C8.68629 3 6 5.68629 6 9C6 12.3137 8.68629 15 12 15ZM12 15V19M12 21V19M12 19H10M12 19H14" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                           Ella
                                    </div>
                                    <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill">🔥Hot</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <p class="small text-end">Hace 3 horas</p>
                            </div>
                        </div>
                        <p class="m-2">iNo van a creer 10 que pasó en la fiesta de anoche! EI drama comenzó cuando...</p>
                        <div class="row d-flex mx-2">
                            <div class="bg-tags p-1 rounded m-1 w-auto">#fiesta</div>
                        </div>
                        <div class="row d-flex gap-2 mx-2">
                            <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🔥</span><span class="ms-4">1233</span>
                            </div>                            
                            <div style="background: var(--orange);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🤥</span><span class="ms-4">34</span>
                            </div>
                            <div class="w-auto mt-2">📧 24</div>
                        </div>
                    </div>
    
                    <div class="p-3 bg-content rounded mb-3 conte">
                        <div class="mx-2 row">
                            <div class="col-9">
                                <div class="row gap-2">
                                    <div style="background: var(--purple);" class="w-auto rounded-pill">
                                        <version="1.0" encoding="UTF-8"?><svg width="24px" height="24px" stroke-width="1.5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" color="#000000">
                                            <path d="M5 20V19C5 15.134 8.13401 12 12 12V12C15.866 12 19 15.134 19 19V20" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path><path d="M12 12C14.2091 12 16 10.2091 16 8C16 5.79086 14.2091 4 12 4C9.79086 4 8 5.79086 8 8C8 10.2091 9.79086 12 12 12Z" stroke="#ffffff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                        Otro
                                    </div>
                                    <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill">🔥Hot</div>
                                </div>
                            </div>
                            <div class="col-3">
                                <p class="small text-end">Hace 2 horas</p>
                            </div>
                        </div>
                        <p class="m-2">¿Alguien más vio al profesor de matemáticas en el centro comercial haciendo...?</p>
                        <div class="row d-flex mx-2">
                            <div class="bg-tags p-1 rounded m-1 w-auto">#recuerdo</div>
                        </div>
                        <div class="row d-flex gap-2 mx-2">
                            <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🔥</span><span class="ms-4">133</span>
                            </div>                            
                            <div style="background: var(--orange);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🤥</span><span class="ms-4">43</span>
                            </div>
                            <div class="w-auto mt-2">📧 6</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna derecha -->
            <div class="col-lg-3">
                <div class="p-3 bg-sidebar rounded mt-sm-4 mt-lg-0 h-100">
                    <h5 class="text-center mb-4">Etiquetas Populares ☝️🥸</h5>
                    <ul class="list-unstyled d-flex flex-wrap">
                        <li><div class="bg-tags p-1 rounded m-1 tarj">#infidelidad</div></li>
                        <li><div class="bg-tags p-1 rounded m-1 tarj">#besos</div></li>
                        <li><div class="bg-tags p-1 rounded m-1 tarj">#inmoral</div></li>
                        <li><div class="bg-tags p-1 rounded m-1 tarj">#secreto</div></li>
                        <li><div class="bg-tags p-1 rounded m-1 tarj">#fiesta</div></li>
                    </ul>
                    <h5 class="text-center mb-4">Destacados 👀</h5>
                    <div style="background: var(--background-link-profile);" class="row  rounded p-3 m-1 mb-3 dest">
                        <p class="small text-center">Hace 2 horas</p>
                        Increible descubren el rumor sobre [...]
                        <div class="row d-flex gap-2">
                            <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🔥</span><span class="ms-4">3123</span>
                            </div>     
                            <div style="background: var(--green);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🤑</span><span class="ms-4">83%</span>
                            </div>
                        </div>
                    </div>
                    <div style="background: var(--background-link-profile);" class="row rounded p-3 m-1 mb-3 dest">
                        <p class="small text-center">Hace 6 horas</p>
                        El escándalo mas grande de la semana: La verdad sobre [...]
                        <div class="row d-flex gap-2">
                            <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🔥</span><span class="ms-4">3012</span>
                            </div>     
                            <div style="background: var(--green);" class="w-auto rounded-pill mt-2 reacc pointer d-flex align-items-center position-relative">
                                <span class="icono position-absolute">🤑</span><span class="ms-4">76%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar el renderer de susurros
            const whisperRenderer = new WhisperRenderer({
                container: document.querySelector('#recent-whispers'),
                infiniteScroll: true,
                showInterests: true,
                showLies: true,
                showResponses: true,
                showViews: false,
                showPercentage: true,
                initialLoad: 20,
                endpoint: '/api/whispers/recent'
            });

            // Inicializar el publicador de susurros
            const whisperPublisher = new WhisperPublisher({
                form: document.querySelector('.whisper-form'),
                messageInput: document.querySelector('.whisper-box'),
                tagsInput: document.querySelector('.tags-box'),
                publishButton: document.querySelector('.btn-publish'),
                renderer: whisperRenderer
            });

            // Inicializar el sistema de etiquetas
            const tagsBox = document.querySelector('.tags-box');
            if (tagsBox && !tagsBox.dataset.initialized) {
                new TagsInput(tagsBox);
            }

            // Inicializar contadores
            const whisperBox = document.querySelector('.whisper-box');
            const charCounter = document.querySelector('.char-counter');
            const tagsCounter = document.querySelector('.tags-counter');

            // Contador de caracteres
            if (whisperBox && charCounter) {
                whisperBox.addEventListener('input', function() {
                    const count = this.value.length;
                    charCounter.textContent = `${count}/500`;
                    charCounter.classList.toggle('text-warning', count >= 450);
                });
            }

            // Contador de etiquetas
            if (tagsCounter) {
                const updateTagsCounter = () => {
                    const tags = JSON.parse(document.querySelector('.tags-box').value || '[]');
                    tagsCounter.textContent = `${tags.length} etiqueta${tags.length !== 1 ? 's' : ''}`;
                };

                // Observador para el contador de etiquetas
                const tagsContainer = document.querySelector('.tags-container');
                if (tagsContainer) {
                    const observer = new MutationObserver(updateTagsCounter);
                    observer.observe(tagsContainer, { 
                        childList: true,
                        subtree: true 
                    });
                }
            }

            // Inicializar búsqueda
            const searchInput = document.querySelector('input[type="search"]');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        const searchText = this.value.trim();
                        if (searchText.length >= 3) {
                            whisperRenderer.options.endpoint = `/api/whispers/search?q=${encodeURIComponent(searchText)}`;
                            whisperRenderer.reloadWhispers();
                        } else if (searchText.length === 0) {
                            whisperRenderer.options.endpoint = '/api/whispers/recent';
                            whisperRenderer.reloadWhispers();
                        }
                    }, 300);
                });
            }

            // Cargar etiquetas populares
            const fetchPopularTags = async () => {
                try {
                    const response = await fetch('/api/whispers/tags');
                    if (response.ok) {
                        const data = await response.json();
                        const tagsContainer = document.querySelector('.list-unstyled.d-flex.flex-wrap');
                        if (tagsContainer && data.tags) {
                            tagsContainer.innerHTML = data.tags
                                .map(tag => `<li><div class="bg-tags p-1 rounded m-1 tarj">${tag.nombre}</div></li>`)
                                .join('');
                        }
                    }
                } catch (error) {
                    console.error('Error cargando etiquetas populares:', error);
                }
            };
            
            // Cargar susurros destacados
            const fetchFeaturedWhispers = async () => {
                try {
                    const response = await fetch('/api/whispers/featured');
                    if (response.ok) {
                        const data = await response.json();
                        const featuredContainer = document.querySelector('.dest').parentElement;
                        if (featuredContainer && data.whispers) {
                            featuredContainer.innerHTML = data.whispers
                                .map(whisper => `
                                    <div style="background: var(--background-link-profile);" class="row rounded p-3 m-1 mb-3 dest">
                                        <p class="small text-center">${whisperRenderer.timeAgo(whisper.fecha_creacion)}</p>
                                        ${whisperRenderer.escapeHtml(whisper.mensaje.substring(0, 50))}...
                                        <div class="row d-flex gap-2">
                                            <div style="background: var(--comment-btn-fire-back);" class="w-auto rounded-pill mt-2 reacc pointer">
                                                🔥${whisper.me_interesa}
                                            </div>     
                                            <div style="background: var(--green);" class="w-auto rounded-pill mt-2 reacc pointer">
                                                🤑${whisper.porcentaje_interes}%
                                            </div>
                                        </div>
                                    </div>
                                `)
                                .join('');
                        }
                    }
                } catch (error) {
                    console.error('Error cargando susurros destacados:', error);
                }
            };

            // Cargar datos iniciales
            fetchPopularTags();
            fetchFeaturedWhispers();
            whisperRenderer.loadMore();
        });
    </script>
</body>
</html>
